<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">

<properties>
  <entry key="default">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks
    FROM
        #if ($isOutboundRequest)
            fact_traffic_adnet f
        #else
            fact_traffic_site f
        #end
    WHERE f.start >= :start AND f.start < :stop
        #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
        #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
        #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
        #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
        #if($siteIds && !$siteIds.isEmpty())
            AND f.site_id IN (:siteIds) ## Sites restriction is present
        #elseif($siteIds && $siteIds.isEmpty())
            AND 1 = 0 ## No sites are allowed
        #end
        #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
            AND (f.hb_type IS NULL OR f.hb_type=-1)
        #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
            AND f.hb_type>=0
        #end
  ]]>
  </entry>

  <entry key="dim=site">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks,
        f.site_id AS siteId,
        d.name AS site
    FROM
        #if ($isOutboundRequest)
            fact_traffic_adnet f
        #else
            fact_traffic_site f
        #end
    INNER JOIN dim_site d ON d.id = f.site_id
    WHERE f.start >= :start AND f.start < :stop
        #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
        #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
        #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
        #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
        #if($siteIds && !$siteIds.isEmpty())
            AND f.site_id IN (:siteIds) ## Sites restriction is present
        #elseif($siteIds && $siteIds.isEmpty())
            AND 1 = 0 ## No sites are allowed
        #end
        #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
            AND (f.hb_type IS NULL OR f.hb_type=-1)
        #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
            AND f.hb_type>=0
        #end
        #if(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner==-999)
            AND (f.hb_partner_pid IS NULL OR f.hb_partner_pid=-999)
        #elseif(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner!=-999)
            AND f.hb_partner_pid = :s2sHbPartner
        #end
    GROUP BY f.site_id, d.name
    ]]>
  </entry>

  <entry key="dim=position">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks,
        f.zone AS position, d.memo AS positionMemo
    FROM
        #if ($isOutboundRequest)
            fact_traffic_adnet f
        #else
            fact_traffic_site f
        #end
    LEFT JOIN dim_position AS d ON f.site_id = d.site_id and f.zone = d.name
    WHERE f.start >= :start AND f.start < :stop
        #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
        #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
        #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
        #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
        #if($siteIds && !$siteIds.isEmpty())
            AND f.site_id IN (:siteIds) ## Sites restriction is present
        #elseif($siteIds && $siteIds.isEmpty())
            AND 1 = 0 ## No sites are allowed
        #end
        #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
            AND (f.hb_type IS NULL OR f.hb_type=-1)
        #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
            AND f.hb_type>=0
        #end
        #if(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner==-999)
            AND (f.hb_partner_pid IS NULL OR f.hb_partner_pid=-999)
        #elseif(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner!=-999)
            AND f.hb_partner_pid = :s2sHbPartner
        #end
    GROUP BY f.zone, d.memo
    ]]>
  </entry>

  <entry key="dim=adsource">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks,
        f.adnet_id AS adSourceId,
        d.name AS adSource
    FROM
        #if ($isOutboundRequest)
            fact_traffic_adnet f
        #else
            fact_traffic_site f
        #end
    INNER JOIN dim_adnet d ON d.id = f.adnet_id
    WHERE f.start >= :start AND f.start < :stop
        #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
        #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
        #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
        #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
        #if($siteIds && !$siteIds.isEmpty())
            AND f.site_id IN (:siteIds) ## Sites restriction is present
        #elseif($siteIds && $siteIds.isEmpty())
            AND 1 = 0 ## No sites are allowed
        #end
        #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
            AND (f.hb_type IS NULL OR f.hb_type=-1)
        #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
            AND f.hb_type>=0
        #end
        #if(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner==-999)
            AND (f.hb_partner_pid IS NULL OR f.hb_partner_pid=-999)
        #elseif(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner!=-999)
            AND f.hb_partner_pid = :s2sHbPartner
        #end
    GROUP BY f.adnet_id, d.name
    ]]>
  </entry>

  <entry key="dim=tag">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks,
        f.tag_id AS adTagId,
        d.name AS adTag
    FROM
        #if ($isOutboundRequest)
            fact_traffic_adnet f
        #else
            fact_traffic_site f
        #end
    INNER JOIN dim_tag d ON d.id = f.tag_id
    WHERE f.start >= :start AND f.start < :stop
        #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
        #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
        #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
        #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
        #if($siteIds && !$siteIds.isEmpty())
            AND f.site_id IN (:siteIds) ## Sites restriction is present
        #elseif($siteIds && $siteIds.isEmpty())
            AND 1 = 0 ## No sites are allowed
        #end
        #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
            AND (f.hb_type IS NULL OR f.hb_type=-1)
        #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
            AND f.hb_type>=0
        #end
        #if(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner==-999)
            AND (f.hb_partner_pid IS NULL OR f.hb_partner_pid=-999)
        #elseif(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner!=-999)
            AND f.hb_partner_pid = :s2sHbPartner
        #end
    GROUP BY f.tag_id, d.name
    ]]>
  </entry>

  <entry key="dim=hour">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks,
        f.interval AS interval
    FROM(
        select f.*,
          TIMESTAMPADD('hour', hour(f.start), date(:start)) AS interval
        FROM
            #if ($isOutboundRequest)
                fact_traffic_adnet f
            #else
                fact_traffic_site f
            #end
        WHERE f.start >= :start AND f.start < :stop
            #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
            #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
            #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
            #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
            #if($siteIds && !$siteIds.isEmpty())
                AND f.site_id IN (:siteIds) ## Sites restriction is present
            #elseif($siteIds && $siteIds.isEmpty())
                AND 1 = 0 ## No sites are allowed
            #end
            #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
                AND (f.hb_type IS NULL OR f.hb_type=-1)
            #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
                AND f.hb_type>=0
            #end
            #if(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner==-999)
                AND (f.hb_partner_pid IS NULL OR f.hb_partner_pid=-999)
            #elseif(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner!=-999)
                AND f.hb_partner_pid = :s2sHbPartner
            #end
    )f
    GROUP BY f.interval
   ]]>
  </entry>

  <entry key="dim=day">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks,
        DATE_TRUNC('day', f.start) AS interval
    FROM
        #if ($isOutboundRequest)
            fact_traffic_adnet f
        #else
            fact_traffic_site f
        #end
    WHERE f.start >= :start AND f.start < :stop
        #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
        #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
        #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
        #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
        #if($siteIds && !$siteIds.isEmpty())
            AND f.site_id IN (:siteIds) ## Sites restriction is present
        #elseif($siteIds && $siteIds.isEmpty())
            AND 1 = 0 ## No sites are allowed
        #end
        #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
            AND (f.hb_type IS NULL OR f.hb_type=-1)
        #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
            AND f.hb_type>=0
        #end
        #if(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner==-999)
            AND (f.hb_partner_pid IS NULL OR f.hb_partner_pid=-999)
        #elseif(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner!=-999)
            AND f.hb_partner_pid = :s2sHbPartner
        #end
    GROUP BY date_trunc('day', f.start)
  ]]>
  </entry>

  <entry key="dim=week">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks,
        greatest(timestamp_trunc(f.start, 'dy'),  to_date(:start, 'YYYY-MM-DD')) AS interval
    FROM
        #if ($isOutboundRequest)
            fact_traffic_adnet f
        #else
            fact_traffic_site f
        #end
    WHERE f.start >= :start AND f.start < :stop
        #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
        #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
        #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
        #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
        #if($siteIds && !$siteIds.isEmpty())
            AND f.site_id IN (:siteIds) ## Sites restriction is present
        #elseif($siteIds && $siteIds.isEmpty())
            AND 1 = 0 ## No sites are allowed
        #end
        #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
            AND (f.hb_type IS NULL OR f.hb_type=-1)
        #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
            AND f.hb_type>=0
        #end
        #if(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner==-999)
            AND (f.hb_partner_pid IS NULL OR f.hb_partner_pid=-999)
        #elseif(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner!=-999)
            AND f.hb_partner_pid = :s2sHbPartner
        #end
    GROUP BY timestamp_trunc(f.start, 'dy')
    ]]>
  </entry>

  <entry key="dim=month">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks,
        DATE_TRUNC('month', f.start) AS interval
    FROM
        #if ($isOutboundRequest)
            fact_traffic_adnet f
        #else
            fact_traffic_site f
        #end
    WHERE f.start >= :start AND f.start < :stop
        #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
        #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
        #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
        #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
        #if($siteIds && !$siteIds.isEmpty())
            AND f.site_id IN (:siteIds) ## Sites restriction is present
        #elseif($siteIds && $siteIds.isEmpty())
            AND 1 = 0 ## No sites are allowed
        #end
        #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
            AND (f.hb_type IS NULL OR f.hb_type=-1)
        #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
            AND f.hb_type>=0
        #end
        #if(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner==-999)
            AND (f.hb_partner_pid IS NULL OR f.hb_partner_pid=-999)
        #elseif(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner!=-999)
            AND f.hb_partner_pid = :s2sHbPartner
        #end
    GROUP BY date_trunc('month', f.start)
   ]]>
  </entry>

  <entry key="dim=headerBidding">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks,
        (CASE WHEN f.hb_type IS NULL OR f.hb_type=-1 THEN 0 ELSE 1 END) AS hbId,
        (CASE WHEN f.hb_type IS NULL OR f.hb_type=-1 THEN 'Waterfall' ELSE 'Header Bidding' END) AS headerBidding
    FROM
        #if ($isOutboundRequest)
            fact_traffic_adnet f
        #else
            fact_traffic_site f
        #end
    WHERE f.start >= :start AND f.start < :stop
        #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
        #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
        #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
        #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
        #if($siteIds && !$siteIds.isEmpty())
            AND f.site_id IN (:siteIds) ## Sites restriction is present
        #elseif($siteIds && $siteIds.isEmpty())
            AND 1 = 0 ## No sites are allowed
        #end
        #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
            AND (f.hb_type IS NULL OR f.hb_type=-1)
        #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
            AND f.hb_type>=0
        #end
        #if(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner==-999)
            AND (f.hb_partner_pid IS NULL OR f.hb_partner_pid=-999)
        #elseif(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner!=-999)
            AND f.hb_partner_pid = :s2sHbPartner
        #end
    GROUP BY headerBidding, hbId
    ORDER BY headerBidding
   ]]>
  </entry>

  <entry key="dim=s2sHbPartner">
    <![CDATA[
    SELECT /* $reportUser.userName */
        /*+label($!reportMetadata.environment$$!reportMetadata.reportType$$!reportMetadata.reportName$$!dim)*/
        #if ($isOutboundRequest)
            SUM(f.ads_requested) AS adRequests,
        #else
            (SUM(f.ads_requested) - COALESCE(SUM(f.ads_bots), 0) - COALESCE(SUM(f.ads_fraud), 0) - COALESCE(SUM(f.ads_throttled), 0)) AS adRequests,
            COALESCE(SUM(f.ads_bots), 0) AS bots,
            COALESCE(SUM(f.ads_fraud), 0) AS frauds,
        #end
        SUM(f.ads_served) AS adServed,
        SUM(f.ads_displayed) AS adDelivered,
        SUM(f.ads_clicked) AS adClicks,
        (CASE WHEN f.hb_partner_pid IS NULL THEN -999 ELSE f.hb_partner_pid END) AS s2sHbPartnerPid,
        ISNULL (d.id, 'Direct') AS s2sHbPartner, ISNULL(d.name, 'Direct') AS s2sHbPartnerName
    FROM
        #if ($isOutboundRequest)
            fact_traffic_adnet f
        #else
            fact_traffic_site f
        #end
    LEFT JOIN dim_hb_partner AS d ON f.hb_partner_pid = d.pid
    WHERE f.start >= :start AND f.start < :stop
        #if(!$StringUtils.isEmpty($adsource)) AND f.adnet_id = :adsource #end
        #if(!$StringUtils.isEmpty($position)) AND f.zone = :position #end
        #if(!$StringUtils.isEmpty($tag)) AND f.tag_id = :tag #end
        #if(!$StringUtils.isEmpty($site)) AND f.site_id = :site #end
        #if($siteIds && !$siteIds.isEmpty())
            AND f.site_id IN (:siteIds) ## Sites restriction is present
        #elseif($siteIds && $siteIds.isEmpty())
            AND 1 = 0 ## No sites are allowed
        #end
        #if(!$StringUtils.isEmpty($headerBidding)&& $headerBidding==0)
            AND (f.hb_type IS NULL OR f.hb_type=-1)
        #elseif(!$StringUtils.isEmpty($headerBidding) && $headerBidding==1)
            AND f.hb_type>=0
        #end
        #if(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner==-999)
            AND (f.hb_partner_pid IS NULL OR f.hb_partner_pid=-999)
        #elseif(!$StringUtils.isEmpty($s2sHbPartner) && $s2sHbPartner!=-999)
            AND f.hb_partner_pid = :s2sHbPartner
        #end
    GROUP BY f.hb_partner_pid, d.id, d.name
    ORDER BY s2sHbPartner
    ]]>
  </entry>

</properties>
